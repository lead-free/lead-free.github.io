<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Embedded Debugging - Stanislav Sotnikov</title><meta name="Description" content="welcome to stan."><meta property="og:title" content="Embedded Debugging" />
<meta property="og:description" content="Continuing the saga on embedded development, this post goes over common ways to debug bare metal ARM, illustrating the technique on blue pill (aka stm32f103c8t6) and most common debugger probes.
The debugger itself is a physical piece of hardware that lives inside the processor and can take control of the cpu and memories. When it comes to ARM, there are two protocols available to interface the on chip debugger &ndash; JTAG and Serial Wire Debug or swd (more about the differences here)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://stansotn.github.io/embedded_debugging/" />
<meta property="og:image" content="https://stansotn.github.io/logo.png"/>
<meta property="article:published_time" content="2020-11-26T17:00:49-05:00" />
<meta property="article:modified_time" content="2020-11-26T17:00:49-05:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://stansotn.github.io/logo.png"/>

<meta name="twitter:title" content="Embedded Debugging"/>
<meta name="twitter:description" content="Continuing the saga on embedded development, this post goes over common ways to debug bare metal ARM, illustrating the technique on blue pill (aka stm32f103c8t6) and most common debugger probes.
The debugger itself is a physical piece of hardware that lives inside the processor and can take control of the cpu and memories. When it comes to ARM, there are two protocols available to interface the on chip debugger &ndash; JTAG and Serial Wire Debug or swd (more about the differences here)."/>
<meta name="application-name" content="Stanislav Sotnikov">
<meta name="apple-mobile-web-app-title" content="Stanislav Sotnikov"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://stansotn.github.io/embedded_debugging/" /><link rel="prev" href="https://stansotn.github.io/embedded_environment/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Embedded Debugging",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/stansotn.github.io\/embedded_debugging\/"
        },"genre": "posts","wordcount":  2584 ,
        "url": "https:\/\/stansotn.github.io\/embedded_debugging\/","datePublished": "2020-11-26T17:00:49-05:00","dateModified": "2020-11-26T17:00:49-05:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Stanislav Sotnikov"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Stanislav Sotnikov">Stanislav Sotnikov</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TZ12BLFVSP"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-TZ12BLFVSP');
    </script>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Stanislav Sotnikov">Stanislav Sotnikov</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TZ12BLFVSP"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-TZ12BLFVSP');
    </script>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title">Embedded Debugging</h1><div class="post-meta">
            <div class="post-meta-line"></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2020-11-26">2020-11-26</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;2584 words&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-probes">1. Probes</a>
      <ul>
        <li><a href="#11-raspberry-pi">1.1 Raspberry Pi</a></li>
        <li><a href="#12-stlink">1.2 stlink</a></li>
        <li><a href="#13-jlink">1.3 jlink</a></li>
      </ul>
    </li>
    <li><a href="#2-gdbserver">2. gdbserver</a>
      <ul>
        <li><a href="#21-openocd--raspberry-pi">2.1. openocd + Raspberry Pi</a></li>
        <li><a href="#22-openocd--stlink">2.2. openocd + stlink</a>
          <ul>
            <li><a href="#221-debian-aarch3264">2.2.1. Debian aarch32/64</a></li>
            <li><a href="#222-ubuntu">2.2.2. Ubuntu</a></li>
            <li><a href="#223-macos">2.2.3. MacOS</a></li>
            <li><a href="#224-workaround">2.2.4. Workaround</a></li>
          </ul>
        </li>
        <li><a href="#23-jlink">2.3. jlink</a></li>
      </ul>
    </li>
    <li><a href="#3-gdb">3. gdb</a>
      <ul>
        <li><a href="#31-gdb--gui">3.1. gdb + gui</a></li>
      </ul>
    </li>
    <li><a href="#afterword">Afterword</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>Continuing the saga on embedded development, this post goes over common ways to debug bare metal ARM, illustrating the technique on <a href="https://hackaday.com/2017/03/30/the-2-32-bit-arduino-with-debugging/" target="_blank" rel="noopener noreffer"><em>blue pill</em></a> (aka <a href="https://www.st.com/en/microcontrollers-microprocessors/stm32f103c8.html" target="_blank" rel="noopener noreffer"><em>stm32f103c8t6</em></a>) and most common debugger probes.</p>
<p>The debugger itself is a physical piece of hardware that lives inside the processor and can take control of the cpu and memories. When it comes to ARM, there are two protocols available to interface the on chip debugger &ndash; <a href="https://en.wikipedia.org/wiki/JTAG" target="_blank" rel="noopener noreffer"><em>JTAG</em></a> and <a href="https://developer.arm.com/architectures/cpu-architecture/debug-visibility-and-trace/coresight-architecture/serial-wire-debug" target="_blank" rel="noopener noreffer"><em>Serial Wire Debug</em></a> or swd (more about the differences <a href="https://electronics.stackexchange.com/questions/53571/jtag-vs-swd-debugging" target="_blank" rel="noopener noreffer"><em>here</em></a>). In this tutorial we will focus on swd, which our blue pill has a pinout for. Apart from the pin count the two interfaces are very similar.</p>
<h2 id="1-probes">1. Probes</h2>
<p>To use the available swd (or jtag) interface you would need a debugger probe and a driver that understands how to talk both to the probe and to the <a href="https://en.wikipedia.org/wiki/GNU_Debugger" target="_blank" rel="noopener noreffer"><em>gnu debugger</em></a> instance (further referred as gdb). Let&rsquo;s call this driver connector program a <a href="https://en.wikipedia.org/wiki/Gdbserver" target="_blank" rel="noopener noreffer"><em>gdbserver</em></a>. This tutorial shines some light on using <a href="https://github.com/ntfreak/openocd" target="_blank" rel="noopener noreffer"><em>Open On Chip Debugger</em></a> or openocd as a gdbserver and its alternatives.</p>
<p>To be clear gdbserver and gdb are different programs:</p>
<ul>
<li>gdbserver &ndash; the driver program that employs the debugger probe, communicates to the outer world via tcp.</li>
<li>gdb &ndash; the client program that loads the executable and interacts with the user (i.e. set breakpoints).</li>
</ul>
<h3 id="11-raspberry-pi">1.1 Raspberry Pi</h3>
<p>Any raspberry pi on its own can serve as a debugger probe thanks to the <a href="https://en.wikipedia.org/wiki/Serial_Peripheral_Interface" target="_blank" rel="noopener noreffer"><em>spi</em></a> driver for openocd developed by <a href="https://github.com/lupyuen/openocd-spi" target="_blank" rel="noopener noreffer"><em>lupyuen</em></a>. This is amazing because there is no need for external debugger probe, making embedded development more accessible <del>to broke students like myself</del>. Chances are you have a raspberry pi collecting dust and you don&rsquo;t have a dedicated debugger hardware (like jlink or stlink). Important to notice, because gdbserver talks to the gdb instance via <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol" target="_blank" rel="noopener noreffer"><em>tcp</em></a>, you can sit back and enjoy the development process (both building and debugging) from an external computer on the network, that is you don&rsquo;t have to develop code on the raspberry pi itself.</p>
<h3 id="12-stlink">1.2 stlink</h3>
<p>An increasingly common probe. stlinks are being included with almost every st&rsquo;s official evaluation board, where besides being a debugger they are also used as a usb to serial converter. As you may have noticed, blue pill does not include an stlink, the on board micro usb receptacle is connected directly to the stm32f103&rsquo;s on chip usb peripheral.</p>
<p>An external <a href="https://www.st.com/en/development-tools/stlink-v3mini.html" target="_blank" rel="noopener noreffer"><em>stlink-v3 mini</em></a> is a tiny, inexpensive and yet powerful debugger. In addition to swd and jtag, it is capable of usb to spi, i2c, can, and gpio interface via a public c++ api <a href="https://www.st.com/en/development-tools/stlink-v3-bridge.html" target="_blank" rel="noopener noreffer"><em>stlink-v3-bridge</em></a>.</p>
<p>The main disadvantage of stlink is that there is no straight forward way to run a compatible gdbserver. For some reason STMicroelectronics does not distribute a gdbserver for stlink as an executable binary as of today, even though gdbserver binaries are included with the <a href="https://www.st.com/en/development-tools/stm32cubeide.html" target="_blank" rel="noopener noreffer"><em>STMCube IDE</em></a> and with little effort can be scrapped from the IDE package (see 2.2.4). From a conversation with an ST developer, turns out their gdbserver is a modified version of openocd publicly developed <a href="https://github.com/STMicroelectronics/OpenOCD" target="_blank" rel="noopener noreffer"><em>here</em></a> and in future might be merged with the original openocd branch.</p>
<h3 id="13-jlink">1.3 jlink</h3>
<p>A royal plug and play probe with official gdbserver binaries available for a wide variety of architectures including raspberry pi. The best choice if you do not have time to grasp openocd and have funds to get the probe.</p>
<h2 id="2-gdbserver">2. gdbserver</h2>
<p>Pick your probe and see what are the options of getting a gdbserver running.</p>
<h3 id="21-openocd--raspberry-pi">2.1. openocd + Raspberry Pi</h3>
<p>Openocd must be built from source to enable swd over spi capability on any raspberry pi. A glance at history; openocd capabilities to make use of the raspberry pi&rsquo;s spi port were developed in <a href="https://github.com/lupyuen/openocd-spi" target="_blank" rel="noopener noreffer"><em>this</em></a> fork, which to the day of writing this post had not been merged into the <a href="https://github.com/ntfreak/openocd" target="_blank" rel="noopener noreffer"><em>original opencod repo</em></a>. The author of the spi tweak published <a href="https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590" target="_blank" rel="noopener noreffer"><em>this</em></a> article on how to get the hack working with Rust and nrf52, beware this only works on a 32 bit raspbian. With appearance of 64 bit Ubuntu for raspberry pi, a <a href="https://github.com/lupyuen/openocd-spi/pull/2" target="_blank" rel="noopener noreffer"><em>pull request</em></a> added aarch64 support. The latter is the particular version of openocd that I tested on raspberry pi, it works both on aarch32 raspbian and aarch64 ubuntu.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">sudo apt install autoconf libtool libusb-1.0-0 libusb-1.0-0-dev
git clone --recursive https://github.com/jeliebig/openocd-spi
<span class="nb">cd</span> openocd-spi
./bootstrap
./configure --enable-bcm2835spi
make
</code></pre></div><p>Feel free to grab some coffee, the build process can take a while. Upon success you will find an openocd binary in the <code>src/</code> folder.</p>
<p>Raspbery pi&rsquo;s spi is disabled by default. Enable spi by writing <code>dtparam=spi=on</code> to <code>/boot/config.txt</code> in Raspbian or <code>/boot/firmware/usercfg.txt</code> in Ubuntu. Reboot. Then, enable read write access to spi port.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">sudo chmod <span class="m">606</span> /dev/spidev0.0
</code></pre></div><p>Create an openocd configuration file.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"># file: swd-pi.ocd
# OpenOCD script for using Raspberry Pi as SWD Programmer for stm32f1x

# Select the Broadcom SPI interface for Raspberry Pi (SWD transport)
interface bcm2835spi

# Set the SPI speed in kHz
bcm2835spi_speed 31200  # 31.2 MHz

# Select stm32f1xx as target
source [find target/stm32f1x.cfg]

# Open gdbserver to the network.
bindto 0.0.0.0
</code></pre></div><p>Connect the blue pill.</p>
<table>
<thead>
<tr>
<th style="text-align:center">blue pill</th>
<th style="text-align:center">raspi</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">swdio</td>
<td style="text-align:center">pin 19</td>
</tr>
<tr>
<td style="text-align:center">swdclk</td>
<td style="text-align:center">pin 23</td>
</tr>
<tr>
<td style="text-align:center">gnd</td>
<td style="text-align:center">gnd</td>
</tr>
</tbody>
</table>
<p>Power up the blue pill. Despite being very convenient, I would not recommend powering the pill from pi&rsquo;s 3.3V line as if you short something on the pill, raspberry will die. If you supply the power through micro usb or 5V line you will likely to kill the pill&rsquo;s linear voltage regulator in case something gets shorted.</p>
<p>Run openocd. Argument <code>-s ../tcl/</code> is a path to the <code>tlc</code> folder where openocd looks for configuration files; argument <code>-f swd-pi.ocd</code> points to the session specific configuration we just created.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># From openocd-spi/src</span>
./openocd -s ~/projects/openocd-spi/tcl/ -f swd-pi.ocd
</code></pre></div><p>Upon success you shall see an output containing</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Info : BCM2835 SPI SWD driver
Info : SWD only mode enabled
Info : clock speed 31200 kHz
Info : SWD DPIDR 0x1ba01477
Info : stm32f1x.cpu: hardware has 6 breakpoints, 4 watchpoints
Info : Listening on port 3333 for gdb connections
</code></pre></div><p>In case you see</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Info : SWD DPIDR 0x0000ffff
</code></pre></div><p>openocd failed to connect to the microcontroller, check connection.</p>
<p>In case you see the following being endlessly printed</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">spi_transmit failed: Bad file descriptor
</code></pre></div><p>Then either spi is disabled or openocd does not have permissions to <code>/dev/spidev0.0</code>. Odds are you can&rsquo;t ctrl+c yourself out of the error, then you need to find and kill the process from a different window.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">pgrep openocd <span class="c1"># Lookup process id.</span>
<span class="nb">kill</span> -9 &lt;process id&gt; <span class="c1"># Kill openocd process.</span>
</code></pre></div><h3 id="22-openocd--stlink">2.2. openocd + stlink</h3>
<p>Getting stlink to cooperate is pretty much about getting openocd to work on your system one way or the other. Let&rsquo;s start with a configuration file for stlink and stm32fxx as it will be the same for any host.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"># file: stlink-swd.ocd

# Select stlink probe
source [find interface/stlink.cfg]

# Select stm32f1xx as target
source [find target/stm32f1x.cfg]

# Select swd 
transport select hla_swd

# Open gdbserver to the network.
bindto 0.0.0.0
</code></pre></div><p>You may notice that openocd is available in a package manager <code>apt</code> or <code>brew</code>, but the version you will get is very outdated (<code>0.1</code> as of today) and will not support stlink-v3 even if you import a proper interface configuration. Also, depending on your system, <code>0.1</code> may crash if the probe is plugged into a usb3 port. Therefore I highly recommend building openocd from source.</p>
<h4 id="221-debian-aarch3264">2.2.1. Debian aarch32/64</h4>
<p>Follow the openocd installation guide for the raspberry pi above, you may skip the spi details if you are not using a raspberry pi or you don&rsquo;t want swd over spi support. Then start openocd with the configuration file for stlink.</p>
<h4 id="222-ubuntu">2.2.2. Ubuntu</h4>
<p>Ubuntu is the most straightforward with building openocd.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">sudo apt install autoconf libtool libusb-1.0-0 libusb-1.0-0-dev <span class="c1"># Dependencies.</span>
git clone --recursive https://github.com/ntfreak/openocd.git <span class="c1"># Original openocd repo.</span>
<span class="nb">cd</span> openocd
./bootstrap
./configure
make -j4
</code></pre></div><p>Upon success you will find an openocd binary in the <code>src/</code> folder.</p>
<p>Grab the configuration script <code>stlink-swd.ocd</code> presented above, connect your target to stlink and stlink to the host computer.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">sudo ./openocd -s ../tcl -f stlink-swd.ocd
</code></pre></div><p>Argument <code>-s ../tcl</code> is a path to the <code>tlc</code> folder where openocd looks for configuration files; argument <code>-f stlink-swd.ocd</code> points to the session specific configuration we just created.</p>
<p>Upon success you shall see a similar output:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Info : clock speed 1000 kHz
Info : STLINK V3J7M2 (API v3)
Info : Target voltage: 3.3
...
Info : Listening on port 3333 for gdb connections
</code></pre></div><h4 id="223-macos">2.2.3. MacOS</h4>
<p>Unfortunately, openocd throws compilation errors on MacOS that I did not have motivation to resolve. The older version is available to install through <code>brew install openocd</code>, but it would not work with the newer stlink-v3. You are encouraged to troubleshoot the build and inform me on your findings.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">brew install autoconf libtool libusb
git clone --recursive https://github.com/ntfreak/openocd.git <span class="c1"># Original openocd repo.</span>
<span class="nb">cd</span> openocd
./bootstrap
<span class="c1"># Here you need to specify the paths to libusb.</span>
./configure <span class="nv">LIBUSB1_CFLAGS</span><span class="o">=</span>-I/usr/local/Cellar/libusb/1.0.23/include/libusb-1.0 <span class="nv">LIBUSB1_LIBS</span><span class="o">=</span>-L/usr/local/Cellar/libusb/1.0.23/lib
make -j4
</code></pre></div><p>Yet it is possible to debug with the latest stlink hardware on MacOS, proceed to <code>2.2.4 Workaround</code>.</p>
<h4 id="224-workaround">2.2.4. Workaround</h4>
<p>As a workaround you could scrape a pre built binary from <a href="https://www.st.com/en/development-tools/stm32cubeide.html" target="_blank" rel="noopener noreffer"><em>STMCubeIDE</em></a>. Tested on MacOS, should work on x86 Ubuntu and Windows. You&rsquo;d have to download the STMCubeIDE package, but do not install it. Instead, extract and browse the package content, look for the following files.</p>
<ul>
<li>ST-LINK_gdbserver</li>
<li>libSTLinkUSBDriver.dylib # .so on linux</li>
<li>STM32_Programmer_CLI</li>
<li>STLinkUpgrade.jar</li>
</ul>
<p>Copy your findings to a separate folder. The gdbserver executable looks for its <code>libSTLinkUSBDriver</code> library in a certain subfolder. Make sure your files are organized as in the following example for macos.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">.
├── ST-LINK_gdbserver
├── STLinkUpgrade.jar
├── STM32_Programmer_CLI
└── native
    └── mac_x64
        └── libSTLinkUSBDriver.dylib # .so on linux
</code></pre></div><p>Otherwise you will get the following error.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">dyld: Library not loaded: @rpath/libSTLinkUSBDriver.dylib
</code></pre></div><p>Connect the hardware. Now you can run the gdbserver as</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">./ST-LINK_gdbserver -e -d -cp .
</code></pre></div><p>Uppon success you shall see</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">ST-LINK device initialization OK
Waiting for debugger connection...
Waiting for connection on port 61234...
</code></pre></div><p>Here <code>-cp .</code> is the path to <code>STM32_Programmer_CLI</code>, <code>-d</code> is for swd. If you look closer into the content of the STMCubeIDE package, you will find a <code>config.txt</code> in the folder with <code>ST-LINK_gdbserver</code>, which goes over all command line arguments the gdbserver can take. Once running, you might experience complaints about libusb, which can be installed with <code>brew install libusb</code> and outdated stlink firmware version, which cab be updated by running <code>STLinkUpgrade.jar</code> (has a gui).</p>
<p>I find <code>ST-LINK_gdbserver</code> easy to use as you do not have to provide any configuration files that openocd requires, it is rather hypocritical of STMicroelectronics not to freely distribute <code>ST-LINK_gdbserver</code>.</p>
<h3 id="23-jlink">2.3. jlink</h3>
<p>Jlink comes with all software ready to go, get it from <a href="https://www.segger.com/products/debug-probes/j-link/tools/j-link-gdb-server/about-j-link-gdb-server/" target="_blank" rel="noopener noreffer"><em>here</em></a>.</p>
<p>Look for <code>JLinkGUIServerExe</code> (warning gui), or <code>JLinkGDBServerCLExe</code> (command line). To avoid the gui prompts you need to provide enough arguments, described <a href="https://wiki.segger.com/J-Link_GDB_Server" target="_blank" rel="noopener noreffer"><em>here</em></a>.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">JLinkGDBServerCLExe -if swd -device stm32f103c8
</code></pre></div><p>Warning: jlink edu is painful to run on a remote server as it requires you to confirm the license agreement in a gui prompt at least once a day. In case you need to work with a remote jlink edu, use openocd instead.</p>
<h2 id="3-gdb">3. gdb</h2>
<p>The GNU Debugger or <a href="https://www.gnu.org/software/gdb/" target="_blank" rel="noopener noreffer"><em>gdb</em></a> is a standard tool for debugging <del>and hacking</del> software in various languages written for various architectures; gdb allows tracing program execution by setting breakpoints, watching memories and processor states.</p>
<p>The example presented in this tutorial is just a tiny glimpse of what gdb is capable of. You can debugg along with <a href="https://github.com/stansotn/blue-pill" target="_blank" rel="noopener noreffer"><em>this</em></a> empty initialization code for blue pill.</p>
<p>Start with loading the firmware containing debug symbols. Most flavors of linux including Ubuntu have gdb installed by default.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gdb blue-pill.elf
</code></pre></div><p>In case you are on macos, the default system debugger is lldb. I use <code>arm-none-eabi-gdb</code> from the embedded arm toolchain package available <a href="https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="noopener noreffer"><em>here</em></a>.</p>
<p>Running gdb will welcome you into the debugger console, your command line output should be looking similar to the following.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Reading symbols from blue-pill.elf...
(gdb)
</code></pre></div><p>Next, make sure your gdbserver (openocd or jlink) is running and listening for connections. If you are familiar with gdb, you may know that you can attach to a process running on the same machine. Since in bare metal scenario, the program being debugged is running on a physically different machine and and likely a different architecture, the gdb connection will always be &ldquo;remote&rdquo; even if the gdbserver is running on the same computer.</p>
<p>The following command establishes connection with the gdbserver. Make sure your ip address and port matches the configuration. In case gdbserver is running on the same computer, you can put <code>localhost</code> instead of the ip address. The port depends on the gdbserver you are running, <code>3333</code> is default for openocd.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">(gdb) target extended-remote 192.168.1.24:3333
</code></pre></div><p>Issuing <code>load</code> will flash the firmware!</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">(gdb) load
</code></pre></div><p>Loading firmware does not reset the mcu, that is the program counter has not been set to the reset handler address. Issue a reset and halt.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">(gdb) monitor reset halt
</code></pre></div><p><code>monitor &lt;expression&gt;</code> command sends the expression to gdbserver, gdb (client) itself does not know what <code>reset halt</code> does.</p>
<p><code>step</code> will progress the program counter to the next location.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">(gdb) step
</code></pre></div><p>Look, we are exiting reset handler! Your output should be similar to the following.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Reset_Handler ()
    at /some_path/startup_stm32f103xb.s:66
</code></pre></div><p>Also, see how gdb knows <code>Reset_Handler()</code> is declared in startup_stm32f103xb.s line 66.</p>
<p>Let&rsquo;s set a breakpoint at the main function.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">(gdb) break main
</code></pre></div><p>Referencing functions by name in gdb will only work with &ldquo;global&rdquo; functions. Let&rsquo;s set a breakpoint in the infinite loop by referring to the corresponding line in file <code>main.c</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">break main.c:96
</code></pre></div><p>To list all breakpoints type <code>info break</code>.<br>
Continue program execution.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">(gdb) continue
</code></pre></div><p>This should take us to Breakpoint 1.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Breakpoint 1, main () at /some_path/blue-pill/sources/src/main.c:74
</code></pre></div><p><code>list</code> will display the proceeding lines of code following our current position. Here you could play with <code>step</code> and <code>next</code>, <code>step</code> will take you to the next program counter location, <code>next</code> &ndash; to the next function call. If you are familiar with debugging in any IDE, <code>step</code> is equivalent of &ldquo;step in&rdquo;, and <code>next</code> is &ldquo;step out&rdquo;. <code>continue</code> to get to our second breakpoint. You can delete all breakpoints by issuing <code>delete</code> or delete a specific breakpoint <code>delete 1</code>, or you can also disable breakpoints with <code>disable</code>. If there is no active breakpoints, issuing <code>continue</code> will continue executions until you manually stop it with ctrl+c &ndash; this halts execution of the debugee and does not exit gdb. There is so much to go on about gdb, we haven&rsquo;t started with watchpoints, processor states and memory.</p>
<p>Also, there is a python api that can help automate testing <del>and hacking</del> with gdb!</p>
<h3 id="31-gdb--gui">3.1. gdb + gui</h3>
<p>Many, if not all IDEs use gdb behind their visual interface. Now you can configure embedded debugging support in your favorite text editor. For instance if you use vscode, add a configuration file <code>.vscode/launch.json</code> in the project root. Make sure you have <code>ms-vscode.cpptools</code> extension. Here is my vscode debug configuration.</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">//</span> <span class="err">file:</span> <span class="err">.vscode/launch.json</span>
<span class="p">{</span> 
    <span class="err">//</span> <span class="err">For</span> <span class="err">more</span> <span class="err">information,</span> <span class="err">visit:</span> <span class="err">https://go.microsoft.com/fwlink/?linkid=830387</span>
    <span class="nt">&#34;configurations&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;debug&#34;</span><span class="p">,</span>
            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;cppdbg&#34;</span><span class="p">,</span>
            <span class="nt">&#34;request&#34;</span><span class="p">:</span> <span class="s2">&#34;launch&#34;</span><span class="p">,</span>
            <span class="nt">&#34;program&#34;</span><span class="p">:</span> <span class="s2">&#34;${workspaceRoot}/build/blue-pill.elf&#34;</span><span class="p">,</span>
            <span class="nt">&#34;miDebuggerPath&#34;</span><span class="p">:</span> <span class="s2">&#34;/Applications/ARM/bin/arm-none-eabi-gdb&#34;</span><span class="p">,</span>
            <span class="err">//</span> <span class="nt">&#34;debugServerPath&#34;</span> <span class="err">and</span> <span class="s2">&#34;debugServerArgs&#34;</span> <span class="err">are</span> <span class="err">commands</span> <span class="err">to</span> <span class="err">start</span> <span class="err">the</span> <span class="err">gdbserver</span>
            <span class="err">//</span><span class="s2">&#34;debugServerPath&#34;</span><span class="p">:</span> <span class="s2">&#34;/Applications/SEGGER/JLink_V662/JLinkGDBServerCLExe&#34;</span><span class="p">,</span>
            <span class="err">//</span><span class="nt">&#34;debugServerArgs&#34;</span><span class="p">:</span> <span class="s2">&#34;-device stm32l412cb -if swd&#34;</span><span class="p">,</span>
            <span class="nt">&#34;cwd&#34;</span><span class="p">:</span> <span class="s2">&#34;${workspaceRoot}&#34;</span><span class="p">,</span>
            <span class="nt">&#34;MIMode&#34;</span><span class="p">:</span> <span class="s2">&#34;gdb&#34;</span><span class="p">,</span>
            <span class="nt">&#34;setupCommands&#34;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Connect to gdbserver&#34;</span><span class="p">,</span>
                    <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;target extended-remote 192.168.1.24:3333&#34;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;load executable&#34;</span><span class="p">,</span>
                    <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;file ${workspaceRoot}/build/blue-pill.elf&#34;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Flash Firmware&#34;</span><span class="p">,</span>
                    <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;load&#34;</span>
                <span class="p">},</span>
                <span class="p">{</span>   
                    <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Reset target&#34;</span><span class="p">,</span>
                    <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;monitor reset halt&#34;</span>
                <span class="p">},</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div><h2 id="afterword">Afterword</h2>
<blockquote>
<p><strong>Help Me Improve</strong><br>
I am learning to write meaningful documentation. I hope you enjoyed this post, please help me back by emailing some feedback!</p>
<ul>
<li>Is information here clear, correct and up to date?</li>
<li>How would you improve this post?</li>
</ul>
</blockquote>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2020-11-26</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/embedded_debugging/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/embedded_environment/" class="prev" rel="prev" title="Embedded Environment"><i class="fas fa-angle-left fa-fw"></i>Embedded Environment</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Stanislav Sotnikov</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
